{% extends "base_dashboard.html" %}

{% block title %}Forecasting - Predictive Sales Dashboard{% endblock %}

{% block content %}
<!-- 1. Synchronized Daily & Weekly Forecasts Section (TOP) -->
<div style="margin-bottom: 30px;">
    <h3 style="color: #374151; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 1.5em;">üìÖ</span>
        Synchronized Forecast Views
    </h3>
    
    <!-- Product Selector for Both Charts -->
    <div style="margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, #f9fafb 0%, #e5e7eb 100%); border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
        <div style="display: grid; grid-template-columns: auto 1fr; gap: 20px; align-items: start;">
            <!-- Product Selection -->
            <div>
                <label for="sync-forecast-product-select" style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px; font-size: 0.9em;">
                    üì¶ Product
                </label>
                <select 
                    id="sync-forecast-product-select" 
                    style="padding: 10px 14px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 0.95em; min-width: 250px; background: white;"
                    onchange="loadSynchronizedForecasts(this.value)"
                >
                    <option value="">-- Select Product --</option>
                </select>
            </div>

            <!-- Date Period Selectors -->
            <div>
                <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px; font-size: 0.9em;">
                    üìÖ Time Period
                </label>
                <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center;">
                    <div style="display: flex; flex-direction: column; gap: 4px;">
                        <span style="font-size: 0.75em; color: #6b7280; font-weight: 500;">Year</span>
                        <select id="forecast-year" style="padding: 8px 12px; border: 2px solid #d1d5db; border-radius: 8px; background: white; min-width: 100px;"></select>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 4px;">
                        <span style="font-size: 0.75em; color: #6b7280; font-weight: 500;">Month</span>
                        <select id="forecast-month" style="padding: 8px 12px; border: 2px solid #d1d5db; border-radius: 8px; background: white; min-width: 130px;"></select>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 4px;">
                        <span style="font-size: 0.75em; color: #6b7280; font-weight: 500;">Week</span>
                        <select id="forecast-week" style="padding: 8px 12px; border: 2px solid #d1d5db; border-radius: 8px; background: white; min-width: 130px;"></select>
                    </div>
                    <button 
                        onclick="loadSynchronizedForecasts()" 
                        style="margin-top: 18px; padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3); transition: all 0.2s;"
                        onmouseover="this.style.background='#059669'; this.style.transform='translateY(-1px)'"
                        onmouseout="this.style.background='#10b981'; this.style.transform='translateY(0)'"
                    >
                        üîÑ Load Forecast
                    </button>
                </div>
                <p style="font-size: 0.8em; color: #6b7280; margin-top: 8px; margin-bottom: 0;">
                    üí° <strong>Daily chart</strong> shows the selected week (Mon-Sun). <strong>Weekly chart</strong> shows the selected month's weeks.
                </p>
            </div>
        </div>
    </div>
    
    <!-- Side-by-Side Charts -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        
        <!-- Daily Forecast Chart -->
        <div class="card" style="padding: 20px;">
            <h4 style="color: #374151; margin-top: 0; display: flex; align-items: center; gap: 10px;">
                üìä Daily Forecast (Selected Week)
            </h4>
            <p style="color: #6b7280; font-size: 0.85em; margin-bottom: 15px;">
                Shows actual sales up to today and forecasted sales for remaining days of the week.
                <br><strong>Green:</strong> Actual | <strong>Orange (Dashed):</strong> Forecast
            </p>
            <div id="daily-forecast-chart-container" style="position: relative; height: 350px;">
                <canvas id="daily-forecast-chart"></canvas>
            </div>
        </div>
        
        <!-- Weekly Forecast Chart -->
        <div class="card" style="padding: 20px;">
            <h4 style="color: #374151; margin-top: 0; display: flex; align-items: center; gap: 10px;">
                üìÖ Weekly Forecast (Selected Month)
            </h4>
            <p style="color: #6b7280; font-size: 0.85em; margin-bottom: 15px;">
                Shows actual total sales for completed weeks and forecasted totals for upcoming weeks.
                <br><strong>Green (Solid):</strong> Actual | <strong>Orange (Striped):</strong> Forecast
            </p>
            <div id="weekly-forecast-chart-container" style="position: relative; height: 350px;">
                <canvas id="weekly-forecast-chart"></canvas>
            </div>
        </div>
        
    </div>
</div>

<!-- 2. Weekly Forecast Preview Table (7-Day Demand Forecast) -->
<div class="card" style="margin-bottom: 20px; padding: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0; display: flex; align-items: center; gap: 10px;">
            üìÖ 7-Day Demand Forecast
        </h3>
        <div style="display: flex; gap: 15px; font-size: 0.85em;">
            <span><span style="color: #ef4444;">‚óè</span> Critical (<span id="critical-count">0</span>)</span>
            <span><span style="color: #f59e0b;">‚óè</span> Low (<span id="low-count">0</span>)</span>
            <span><span style="color: #10b981;">‚óè</span> OK</span>
        </div>
    </div>
    <p style="color: #6b7280; margin-bottom: 15px; font-size: 0.9em;">
        Predicted demand for next 7 days vs current stock levels. Plan restocking accordingly.
    </p>
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">Product</th>
                    <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">Current Stock</th>
                    <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">7-Day Forecast</th>
                    <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">Status</th>
                    <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151;">Action</th>
                </tr>
            </thead>
            <tbody id="weekly-forecast-table">
                <tr>
                    <td colspan="5" style="padding: 20px; text-align: center; color: #9ca3af;">
                        Loading forecast data...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- 3. Forecast Accuracy Widget -->
<div class="card" style="margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
    <h3 style="margin-top: 0; display: flex; align-items: center; gap: 10px;">
        üéØ Forecast Accuracy
    </h3>
    <p style="font-size: 0.9em; opacity: 0.9; margin-bottom: 20px;">
        Model performance based on actual vs predicted sales. Target: 80% accuracy.
    </p>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
        <div class="accuracy-metric" style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">
            <div style="font-size: 0.85em; opacity: 0.9; margin-bottom: 5px;">1-Day Forecast</div>
            <div id="accuracy-1d" style="font-size: 2em; font-weight: bold;">--</div>
            <div id="accuracy-1d-status" style="font-size: 0.8em; margin-top: 5px; opacity: 0.8;">Calculating...</div>
        </div>
        <div class="accuracy-metric" style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">
            <div style="font-size: 0.85em; opacity: 0.9; margin-bottom: 5px;">7-Day Forecast</div>
            <div id="accuracy-7d" style="font-size: 2em; font-weight: bold;">--</div>
            <div id="accuracy-7d-status" style="font-size: 0.8em; margin-top: 5px; opacity: 0.8;">Calculating...</div>
        </div>
        <div class="accuracy-metric" style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; backdrop-filter: blur(10px);">
            <div style="font-size: 0.85em; opacity: 0.9; margin-bottom: 5px;">30-Day Forecast</div>
            <div id="accuracy-30d" style="font-size: 2em; font-weight: bold;">--</div>
            <div id="accuracy-30d-status" style="font-size: 0.8em; margin-top: 5px; opacity: 0.8;">Calculating...</div>
        </div>
    </div>
    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2); font-size: 0.85em; opacity: 0.9;">
        ‚ÑπÔ∏è <strong>Note:</strong> Accuracy is calculated by comparing past forecasts with actual sales. Since forecasts are generated for future dates, accuracy metrics will show once those dates pass and actual sales data is available. Upload daily CSV files to enable accuracy tracking.
    </div>
</div>

<!-- Forecast History & Comparison removed and consolidated into synchronized views -->

{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='app.js') }}"></script>
<script>
    // Initialize forecasting page
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Forecasting page loaded');
        
        // Load initial data
        if (typeof loadSynchronizedForecasts === 'function') {
            loadSynchronizedForecasts();
        }
        
        if (typeof loadWeeklyForecast === 'function') {
            loadWeeklyForecast();
        }
        
        if (typeof loadForecastAccuracy === 'function') {
            loadForecastAccuracy();
        }
        
        // Populate product selectors
        if (typeof populateProductSelectors === 'function') {
            populateProductSelectors();
        }
    });
</script>
{% endblock %}
