{% extends "base_dashboard.html" %}

{% block title %}Products - Predictive Sales Dashboard{% endblock %}

{% block content %}
{% if can_edit %}
<div class="product-management">
    <h3>üì¶ Product Management</h3>
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h4 style="margin: 0;">Products</h4>
        <button type="button" class="btn btn-primary" onclick="openProductModal()">
            ‚ûï Add New Product
        </button>
    </div>
    
    <div style="margin-bottom: 15px;">
        <input type="text" id="product-search" placeholder="üîç Search products by name or category..." style="padding: 12px 16px; border-radius: 8px; border: 1px solid #d1d5db; width: 100%; font-size: 14px; transition: all 0.2s;">
    </div>
    
    <div id="products-list" style="max-height: 600px; overflow-y: auto; padding: 12px; background: #f9fafb; border-radius: 8px;">
        <p style="padding: 40px 20px; color: #9ca3af; text-align: center; font-size: 0.95rem;">Loading products...</p>
    </div>
</div>

<!-- Data Management Section -->
<div class="data-management" style="margin-top: 30px;">
    <h3>üìä Data Management</h3>
    
    <!-- Info Box about Unified CSV -->
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(102,126,234,0.3);">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
            <strong style="font-size: 1.1em;">NEW: Unified Sales CSV Format</strong>
        </div>
        <p style="margin: 5px 0; font-size: 0.9em; opacity: 0.95;">
            Upload ONE file with sales + products + inventory! Perfect for POS system exports.
        </p>
        <p style="margin: 5px 0; font-size: 0.85em; opacity: 0.9;">
            üìÑ See <code style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 3px;">sample_unified_sales.csv</code> for example format
        </p>
    </div>
    
    <div class="data-controls">
        <div class="control-group">
            <h4>Import Data</h4>
            <select id="data-type-select" style="margin-bottom: 10px; padding: 8px; border-radius: 4px; border: 1px solid #ddd; font-weight: 500;">
                <option value="unified_sales">‚≠ê Unified Sales (Recommended - All-in-One)</option>
                <option value="sales">Sales Data (Legacy)</option>
                <option value="products">Products Only</option>
                <option value="inventory">Inventory Adjustments</option>
            </select>
            <input type="file" id="csv-import" accept=".csv" />
            <button class="btn btn-primary" id="upload-csv-btn">Import CSV</button>
            <div id="import-status" style="margin-top: 10px;"></div>
        </div>
        
        <div class="control-group">
            <h4>Export Data</h4>
            <button class="btn btn-secondary" id="download-all-data-btn">Download All Data (CSV)</button>
        </div>

        <div class="control-group">
            <h4>Previous Imports</h4>
            <div id="imports-list" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px;">
                <p style="color: #999;">Loading imports...</p>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="card" style="padding:16px;">
    <h3>üì¶ Products</h3>
    <p style="color:#6b7280;">View products and inventory levels. Product management requires admin or manager privileges.</p>
</div>
{% endif %}

<!-- Product Management Modal -->
<div id="product-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="product-modal-title">Add Product</h3>
            <span class="modal-close" onclick="closeProductModal()">&times;</span>
        </div>
        <form id="product-modal-form">
            <input type="hidden" id="modal-product-id" />
            <div class="form-group">
                <label for="modal-product-name">Product Name *</label>
                <input type="text" id="modal-product-name" required />
            </div>
            <div class="form-group">
                <label for="modal-product-category">Category</label>
                <input type="text" id="modal-product-category" />
            </div>
            <div class="form-group">
                <label for="modal-product-cost">Unit Cost (‚Ç±)</label>
                <input type="number" id="modal-product-cost" step="0.01" min="0" />
            </div>
            <div class="form-group" id="modal-stock-group">
                <label for="modal-product-stock">Initial Stock</label>
                <input type="number" id="modal-product-stock" value="0" min="0" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeProductModal()">Cancel</button>
                <button type="submit" class="btn btn-primary" id="product-modal-submit">Save Product</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="modal">
    <div class="modal-content modal-small">
        <div class="modal-header">
            <h3>Confirm Deletion</h3>
            <span class="modal-close" onclick="closeDeleteModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p id="delete-modal-message"></p>
            <p id="delete-modal-warning" style="color: #ef4444; font-size: 0.9em; margin-top: 10px;"></p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
            <button type="button" id="confirm-delete-btn" class="btn btn-danger">Delete Product</button>
        </div>
    </div>
</div>

<!-- Inventory Adjustment Modal -->
<div id="inventory-modal" class="modal">
    <div class="modal-content modal-small">
        <div class="modal-header">
            <h3>Adjust Inventory</h3>
            <span class="modal-close" onclick="closeInventoryModal()">&times;</span>
        </div>
        <form id="inventory-modal-form">
            <input type="hidden" id="inventory-product-id" />
            <div class="form-group">
                <label>Product: <strong id="inventory-product-name"></strong></label>
            </div>
            <div class="form-group">
                <label>Current Stock: <strong id="inventory-current-stock"></strong></label>
            </div>
            <div class="form-group">
                <label for="inventory-operation">Operation</label>
                <select id="inventory-operation" required>
                    <option value="add">Add Stock (+)</option>
                    <option value="remove">Remove Stock (-)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="inventory-quantity">Quantity *</label>
                <input type="number" id="inventory-quantity" min="1" required />
            </div>
            <div class="form-group">
                <label for="inventory-reason">Reason (optional)</label>
                <input type="text" id="inventory-reason" placeholder="e.g., Received shipment, Damaged goods..." />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeInventoryModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Adjust Inventory</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='app.js') }}"></script>
<script>
    // Initialize products page
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Products page loaded');
        
        // Load products list
        if (typeof loadProductsList === 'function') {
            loadProductsList();
        }
        
        // Load import history
        if (typeof loadImportHistory === 'function') {
            loadImportHistory();
        }
        
        // Set up search functionality
        const searchInput = document.getElementById('product-search');
        if (searchInput) {
            searchInput.addEventListener('input', function(e) {
                if (typeof filterProducts === 'function') {
                    filterProducts(e.target.value);
                }
            });
        }
        
        // CSV upload button handler
        const uploadBtn = document.getElementById('upload-csv-btn');
        if (uploadBtn) {
            uploadBtn.addEventListener('click', function() {
                if (typeof handleCSVUpload === 'function') {
                    handleCSVUpload();
                }
            });
        }
        
        // Download all data button handler
        const downloadBtn = document.getElementById('download-all-data-btn');
        if (downloadBtn) {
            downloadBtn.addEventListener('click', function() {
                if (typeof downloadAllData === 'function') {
                    downloadAllData();
                }
            });
        }
    });
</script>
{% endblock %}
