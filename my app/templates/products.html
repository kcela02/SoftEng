{% extends "base_dashboard.html" %}

{% block title %}Products - Predictive Sales Dashboard{% endblock %}

{% block content %}
{% if can_edit %}
<div class="product-management">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
            <h3 style="margin: 0;">üì¶ Product Management</h3>
            <p style="margin: 4px 0 0; font-size: 0.85em; color: #6b7280;">
                ‚è∞ FIFO inventory tracking with batch expiration management
            </p>
        </div>
        <button type="button" class="btn btn-primary" onclick="openProductModal()" style="padding: 6px 12px !important; font-size: 13px !important; font-weight: 500; white-space: nowrap;">
            ‚ûï Add New Product
        </button>
    </div>
    
    <div style="margin-bottom: 15px;">
        <input type="text" id="product-search" placeholder="üîç Search products by name or category..." style="padding: 12px 16px; border-radius: 8px; border: 1px solid #d1d5db; width: 100%; font-size: 14px; transition: all 0.2s;">
    </div>
    
    <div id="products-list" style="max-height: 600px; overflow-y: auto; padding: 12px; background: #f9fafb; border-radius: 8px;">
        <p style="padding: 40px 20px; color: #9ca3af; text-align: center; font-size: 0.95rem;">Loading products...</p>
    </div>
</div>

<!-- Data Management Section -->
<div class="data-management" style="margin-top: 30px;">
    <h3>üìä Data Management</h3>
    
    <!-- CSV Upload Instructions -->
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(102,126,234,0.2);">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <span style="font-size: 2em;">üìÅ</span>
            <strong style="font-size: 1.2rem; font-weight: 600;">CSV Upload Guide - Multiple Formats Supported</strong>
        </div>
        
        <div style="margin-bottom: 16px; padding: 12px; background: rgba(255,255,255,0.15); border-radius: 8px;">
            <strong style="display: block; margin-bottom: 8px;">üìä Sales Data (unified_sales):</strong>
            <p style="margin: 4px 0; font-size: 0.95em; line-height: 1.6;">
                Columns: <code style="background: rgba(255,255,255,0.25); padding: 3px 8px; border-radius: 4px; font-size: 0.9em;">product_name</code>, 
                <code style="background: rgba(255,255,255,0.25); padding: 3px 8px; border-radius: 4px; font-size: 0.9em;">quantity_sold</code>, 
                <code style="background: rgba(255,255,255,0.25); padding: 3px 8px; border-radius: 4px; font-size: 0.9em;">sale_price</code>, 
                <code style="background: rgba(255,255,255,0.25); padding: 3px 8px; border-radius: 4px; font-size: 0.9em;">sale_date</code>
            </p>
            <p style="margin: 4px 0 0; font-size: 0.85em; opacity: 0.9;">
                üí° Optional: category, unit_cost, stock_after_sale | ‚ö° Auto-deducts using FIFO batch system
            </p>
        </div>
        
        <div style="padding: 12px; background: rgba(255,255,255,0.15); border-radius: 8px;">
            <strong style="display: block; margin-bottom: 8px;">üì¶ Inventory Batches (batches) - NEW:</strong>
            <p style="margin: 4px 0; font-size: 0.95em; line-height: 1.6;">
                Columns: <code style="background: rgba(255,255,255,0.25); padding: 3px 8px; border-radius: 4px; font-size: 0.9em;">product_name</code>, 
                <code style="background: rgba(255,255,255,0.25); padding: 3px 8px; border-radius: 4px; font-size: 0.9em;">quantity</code>, 
                <code style="background: rgba(255,255,255,0.25); padding: 3px 8px; border-radius: 4px; font-size: 0.9em;">expiration_date</code>
            </p>
            <p style="margin: 4px 0 0; font-size: 0.85em; opacity: 0.9;">
                üí° Optional: batch_number, received_date, unit_cost, supplier, notes | ‚è∞ Tracks expiration dates for FIFO management
            </p>
        </div>
    </div>
    
    <div class="data-controls">
        <div class="control-group">
            <h4>Import Data</h4>
            <input type="file" id="csv-import" accept=".csv" style="margin-bottom: 10px;" />
            <button class="btn btn-primary" id="upload-csv-btn">üì§ Upload CSV File</button>
            <div id="import-status" style="margin-top: 10px;"></div>
        </div>
        
        <div class="control-group">
            <h4>Export Data</h4>
            <button class="btn btn-secondary" id="download-all-data-btn">Download All Data (CSV)</button>
        </div>

        <div class="control-group">
            <h4>Previous Imports</h4>
            <div id="imports-list" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px;">
                <p style="color: #999;">Loading imports...</p>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="card" style="padding:16px;">
    <h3>üì¶ Products</h3>
    <p style="color:#6b7280;">View products and inventory levels. Product management requires admin or manager privileges.</p>
</div>
{% endif %}

<!-- Product Management Modal -->
<div id="product-modal" class="modal">
    <div class="modal-content" style="max-width: 520px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-bottom: none; padding: 28px 32px;">
            <h3 id="product-modal-title" style="color: white; font-size: 1.4rem; font-weight: 600; margin: 0;">Add Product</h3>
            <span class="modal-close" onclick="closeProductModal()" style="color: white; opacity: 0.9; font-size: 28px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer; transition: all 0.2s;">&times;</span>
        </div>
        <form id="product-modal-form" style="padding: 32px;">
            <input type="hidden" id="modal-product-id" />
            <div class="form-group" style="margin-bottom: 24px;">
                <label for="modal-product-name" style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #2d3748; font-size: 14px; margin-bottom: 8px;">
                    <span style="font-size: 18px;">üì¶</span> Product Name *
                </label>
                <input type="text" id="modal-product-name" required style="width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; transition: all 0.2s;" />
            </div>
            <div class="form-group" style="margin-bottom: 24px;">
                <label for="modal-product-category" style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #2d3748; font-size: 14px; margin-bottom: 8px;">
                    <span style="font-size: 18px;">üè∑Ô∏è</span> Category
                </label>
                <input type="text" id="modal-product-category" style="width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; transition: all 0.2s;" />
            </div>
            <div class="form-group" style="margin-bottom: 24px;">
                <label for="modal-product-cost" style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #2d3748; font-size: 14px; margin-bottom: 8px;">
                    <span style="font-size: 18px;">üí∞</span> Unit Cost (‚Ç±)
                </label>
                <input type="number" id="modal-product-cost" step="0.01" min="0" style="width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; transition: all 0.2s;" />
            </div>
            <!-- Removed free-form initial stock input. Initial stock must be added as a batch with expiration date -->
            
            <!-- Batch Information Section (shown for new products) -->
            <div id="batch-info-section" style="margin-bottom: 24px; padding: 16px; background: #f0f9ff; border: 2px dashed #3b82f6; border-radius: 10px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                    <span style="font-size: 18px;">‚è∞</span>
                    <strong style="color: #1e40af; font-size: 14px;">FIFO Batch Tracking (Required for initial stock)</strong>
                </div>
                <p style="font-size: 0.85em; color: #1e40af; margin-bottom: 12px;">Provide a batch with expiration date for any initial stock. Adding stock without expiration is no longer supported.</p>
                
                <div class="form-group" style="margin-bottom: 12px;">
                    <label for="modal-batch-number" style="font-size: 13px; color: #374151; margin-bottom: 4px; display: block;">Batch Number</label>
                    <input type="text" id="modal-batch-number" placeholder="Auto-generated if empty" style="width: 100%; padding: 10px 12px; border: 1px solid #bfdbfe; border-radius: 6px; font-size: 14px;" />
                </div>
                
                <div class="form-group" style="margin-bottom: 12px;">
                    <label for="modal-batch-quantity" style="font-size: 13px; color: #374151; margin-bottom: 4px; display: block;">Initial Batch Quantity *</label>
                    <input type="number" id="modal-batch-quantity" value="0" min="0" style="width: 100%; padding: 10px 12px; border: 1px solid #bfdbfe; border-radius: 6px; font-size: 14px;" />
                </div>

                <div class="form-group" style="margin-bottom: 12px;">
                    <label for="modal-expiration-date" style="font-size: 13px; color: #374151; margin-bottom: 4px; display: block;">Expiration Date *</label>
                    <input type="date" id="modal-expiration-date" style="width: 100%; padding: 10px 12px; border: 1px solid #bfdbfe; border-radius: 6px; font-size: 14px;" />
                </div>
                
                <div class="form-group" style="margin-bottom: 12px;">
                    <label for="modal-supplier" style="font-size: 13px; color: #374151; margin-bottom: 4px; display: block;">Supplier</label>
                    <input type="text" id="modal-supplier" placeholder="Supplier name" style="width: 100%; padding: 10px 12px; border: 1px solid #bfdbfe; border-radius: 6px; font-size: 14px;" />
                </div>
                
                <div class="form-group">
                    <label for="modal-batch-notes" style="font-size: 13px; color: #374151; margin-bottom: 4px; display: block;">Notes</label>
                    <textarea id="modal-batch-notes" rows="2" placeholder="Optional notes about this batch" style="width: 100%; padding: 10px 12px; border: 1px solid #bfdbfe; border-radius: 6px; font-size: 14px; resize: vertical;"></textarea>
                </div>
            </div>
            
            <div class="modal-footer" style="display: flex; gap: 12px; padding-top: 8px;">
                <button type="button" class="btn btn-secondary" onclick="closeProductModal()" style="flex: 1; padding: 14px; border-radius: 10px; font-size: 15px; font-weight: 600; background: #f7fafc; color: #4a5568; border: 2px solid #e2e8f0; cursor: pointer; transition: all 0.2s;">Cancel</button>
                <button type="submit" class="btn btn-primary" id="product-modal-submit" style="flex: 2; padding: 14px; border-radius: 10px; font-size: 15px; font-weight: 600; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">Save Product</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="modal">
    <div class="modal-content modal-small" style="max-width: 460px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-bottom: none; padding: 28px 32px;">
            <h3 style="color: white; font-size: 1.3rem; font-weight: 600; margin: 0; display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 24px;">‚ö†Ô∏è</span> Confirm Deletion
            </h3>
            <span class="modal-close" onclick="closeDeleteModal()" style="color: white; opacity: 0.9; font-size: 28px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer; transition: all 0.2s;">&times;</span>
        </div>
        <div class="modal-body" style="padding: 32px;">
            <p id="delete-modal-message" style="font-size: 15px; color: #2d3748; margin-bottom: 16px; line-height: 1.6;"></p>
            <p id="delete-modal-warning" style="color: #ef4444; font-size: 14px; margin-top: 16px; padding: 12px; background: #fef2f2; border-left: 4px solid #ef4444; border-radius: 6px;"></p>
        </div>
        <div class="modal-footer" style="display: flex; gap: 12px; padding: 0 32px 32px;">
            <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()" style="flex: 1; padding: 14px; border-radius: 10px; font-size: 15px; font-weight: 600; background: #f7fafc; color: #4a5568; border: 2px solid #e2e8f0; cursor: pointer; transition: all 0.2s;">Cancel</button>
            <button type="button" id="confirm-delete-btn" class="btn btn-danger" style="flex: 1; padding: 14px; border-radius: 10px; font-size: 15px; font-weight: 600; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);">Delete Product</button>
        </div>
    </div>
</div>

<!-- Inventory Update Modal -->
<div id="inventory-modal" class="modal">
    <div class="modal-content modal-small" style="max-width: 520px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-bottom: none; padding: 28px 32px;">
            <h3 style="color: white; font-size: 1.3rem; font-weight: 600; margin: 0; display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 24px;">üì¶</span> Update Inventory
            </h3>
            <span class="modal-close" onclick="closeInventoryModal()" style="color: white; opacity: 0.9; font-size: 28px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer; transition: all 0.2s;">&times;</span>
        </div>
        <form id="inventory-modal-form" style="padding: 32px;">
            <input type="hidden" id="inventory-product-id" />
            <div class="form-group" style="margin-bottom: 20px; padding: 16px; background: #f0fdf4; border-radius: 10px; border-left: 4px solid #10b981;">
                <label style="font-size: 13px; color: #065f46; font-weight: 600; margin-bottom: 4px; display: block;">Product</label>
                <strong id="inventory-product-name" style="font-size: 16px; color: #047857;"></strong>
            </div>
            <div class="form-group" style="margin-bottom: 24px; padding: 16px; background: #eff6ff; border-radius: 10px; border-left: 4px solid #3b82f6;">
                <label style="font-size: 13px; color: #1e40af; font-weight: 600; margin-bottom: 4px; display: block;">Current Stock</label>
                <strong id="inventory-current-stock" style="font-size: 20px; color: #2563eb;"></strong>
            </div>
            <div class="form-group" style="margin-bottom: 24px;">
                <label for="inventory-operation" style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #2d3748; font-size: 14px; margin-bottom: 8px;">
                    <span style="font-size: 18px;">üîÑ</span> Operation
                </label>
                <select id="inventory-operation" required style="width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; transition: all 0.2s; background: white; cursor: pointer;">
                    <option value="add">‚ûï Add Stock</option>
                    <option value="remove">‚ûñ Remove Stock</option>
                </select>
            </div>
            <div class="form-group" style="margin-bottom: 24px;">
                <label for="inventory-quantity" style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #2d3748; font-size: 14px; margin-bottom: 8px;">
                    <span style="font-size: 18px;">üî¢</span> Quantity *
                </label>
                <input type="number" id="inventory-quantity" min="1" required style="width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; transition: all 0.2s;" />
            </div>
            <div class="form-group" style="margin-bottom: 28px;">
                <label for="inventory-reason" style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #2d3748; font-size: 14px; margin-bottom: 8px;">
                    <span style="font-size: 18px;">üìù</span> Reason (optional)
                </label>
                <input type="text" id="inventory-reason" placeholder="e.g., Received shipment, Damaged goods..." style="width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; transition: all 0.2s;" />
            </div>
            
            <div style="padding: 12px; background: #fffbeb; border: 1px solid #fbbf24; border-radius: 8px; margin-bottom: 20px;">
                <p style="margin: 0; font-size: 0.85em; color: #92400e;">
                    üí° <strong>Tip:</strong> For better tracking, use <strong>"Add Batch"</strong> button below to add inventory with expiration dates (FIFO system).
                </p>
            </div>
            
            <div class="modal-footer" style="display: flex; gap: 12px; padding-top: 8px;">
                <button type="button" class="btn btn-secondary" onclick="closeInventoryModal()" style="flex: 1; padding: 14px; border-radius: 10px; font-size: 15px; font-weight: 600; background: #f7fafc; color: #4a5568; border: 2px solid #e2e8f0; cursor: pointer; transition: all 0.2s;">Cancel</button>
                <button type="button" class="btn" onclick="openAddBatchModal()" style="flex: 1; padding: 14px; border-radius: 10px; font-size: 15px; font-weight: 600; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(240, 147, 251, 0.3);">‚è∞ Add Batch</button>
                <button type="submit" class="btn btn-primary" style="flex: 2; padding: 14px; border-radius: 10px; font-size: 15px; font-weight: 600; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">Update Inventory</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Batch Modal -->
<div id="add-batch-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-bottom: none; padding: 28px 32px;">
            <h3 style="color: white; font-size: 1.4rem; font-weight: 600; margin: 0; display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 24px;">‚è∞</span> Add Inventory Batch
            </h3>
            <span class="modal-close" onclick="closeAddBatchModal()" style="color: white; opacity: 0.9; font-size: 28px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer; transition: all 0.2s;">&times;</span>
        </div>
        <form id="add-batch-form" style="padding: 32px;">
            <input type="hidden" id="batch-product-id" />
            
            <div class="form-group" style="margin-bottom: 20px; padding: 16px; background: #fef3c7; border-radius: 10px; border-left: 4px solid #f59e0b;">
                <label style="font-size: 13px; color: #92400e; font-weight: 600; margin-bottom: 4px; display: block;">Product</label>
                <strong id="batch-product-name" style="font-size: 16px; color: #b45309;"></strong>
            </div>
            
            <div class="form-group" style="margin-bottom: 20px;">
                <label for="batch-quantity" style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #2d3748; font-size: 14px; margin-bottom: 8px;">
                    <span style="font-size: 18px;">üì¶</span> Quantity *
                </label>
                <input type="number" id="batch-quantity" min="1" required style="width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px;" />
            </div>
            
            <div class="form-group" style="margin-bottom: 20px;">
                <label for="batch-expiration" style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #2d3748; font-size: 14px; margin-bottom: 8px;">
                    <span style="font-size: 18px;">üìÖ</span> Expiration Date *
                </label>
                <input type="date" id="batch-expiration" required style="width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px;" />
            </div>
            
            <div class="form-group" style="margin-bottom: 20px;">
                <label for="batch-number-input" style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #2d3748; font-size: 14px; margin-bottom: 8px;">
                    <span style="font-size: 18px;">üî¢</span> Batch Number
                </label>
                <input type="text" id="batch-number-input" placeholder="Auto-generated if empty" style="width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px;" />
            </div>
            
            <div class="form-group" style="margin-bottom: 20px;">
                <label for="batch-unit-cost" style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #2d3748; font-size: 14px; margin-bottom: 8px;">
                    <span style="font-size: 18px;">üí∞</span> Unit Cost (‚Ç±)
                </label>
                <input type="number" id="batch-unit-cost" step="0.01" min="0" placeholder="Optional" style="width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px;" />
            </div>
            
            <div class="form-group" style="margin-bottom: 20px;">
                <label for="batch-supplier" style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #2d3748; font-size: 14px; margin-bottom: 8px;">
                    <span style="font-size: 18px;">üè≠</span> Supplier
                </label>
                <input type="text" id="batch-supplier" placeholder="Supplier name" style="width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px;" />
            </div>
            
            <div class="form-group" style="margin-bottom: 24px;">
                <label for="batch-notes" style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #2d3748; font-size: 14px; margin-bottom: 8px;">
                    <span style="font-size: 18px;">üìù</span> Notes
                </label>
                <textarea id="batch-notes" rows="3" placeholder="Optional notes about this batch" style="width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; resize: vertical;"></textarea>
            </div>
            
            <div style="padding: 12px; background: #dbeafe; border-radius: 8px; margin-bottom: 20px;">
                <p style="margin: 0; font-size: 0.85em; color: #1e40af;">
                    üí° This batch will be tracked with FIFO (First-In-First-Out). Sales will automatically deduct from batches with the oldest expiration dates first.
                </p>
            </div>
            
            <div class="modal-footer" style="display: flex; gap: 12px; padding-top: 8px;">
                <button type="button" class="btn btn-secondary" onclick="closeAddBatchModal()" style="flex: 1; padding: 14px; border-radius: 10px; font-size: 15px; font-weight: 600; background: #f7fafc; color: #4a5568; border: 2px solid #e2e8f0; cursor: pointer; transition: all 0.2s;">Cancel</button>
                <button type="submit" class="btn btn-primary" style="flex: 2; padding: 14px; border-radius: 10px; font-size: 15px; font-weight: 600; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(240, 147, 251, 0.3);">Add Batch</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='app.js') }}"></script>
<script>
    // Initialize products page
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Products page loaded');
        
        // Load products list
        if (typeof loadProductsList === 'function') {
            loadProductsList();
        }
        
        // Load import history
        if (typeof loadImportHistory === 'function') {
            loadImportHistory();
        }
        
        // Set up search functionality
        const searchInput = document.getElementById('product-search');
        if (searchInput) {
            searchInput.addEventListener('input', function(e) {
                if (typeof filterProducts === 'function') {
                    filterProducts(e.target.value);
                }
            });
        }
        
        // CSV upload button handler
        const uploadBtn = document.getElementById('upload-csv-btn');
        if (uploadBtn) {
            uploadBtn.addEventListener('click', function() {
                if (typeof handleCSVUpload === 'function') {
                    handleCSVUpload();
                }
            });
        }
        
        // Download all data button handler
        const downloadBtn = document.getElementById('download-all-data-btn');
        if (downloadBtn) {
            downloadBtn.addEventListener('click', function() {
                if (typeof downloadAllData === 'function') {
                    downloadAllData();
                }
            });
        }
    });
</script>
{% endblock %}
