{% extends "base_dashboard.html" %}

{% block title %}Products - Predictive Sales Dashboard{% endblock %}

{% block content %}
{% if can_edit %}
<div class="product-management">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0;">üì¶ Product Management</h3>
        <button type="button" class="btn btn-primary" onclick="openProductModal()" style="padding: 6px 12px !important; font-size: 13px !important; font-weight: 500; white-space: nowrap;">
            ‚ûï Add New Product
        </button>
    </div>
    
    <div style="margin-bottom: 15px;">
        <input type="text" id="product-search" placeholder="üîç Search products by name or category..." style="padding: 12px 16px; border-radius: 8px; border: 1px solid #d1d5db; width: 100%; font-size: 14px; transition: all 0.2s;">
    </div>
    
    <div id="products-list" style="max-height: 600px; overflow-y: auto; padding: 12px; background: #f9fafb; border-radius: 8px;">
        <p style="padding: 40px 20px; color: #9ca3af; text-align: center; font-size: 0.95rem;">Loading products...</p>
    </div>
</div>

<!-- Data Management Section -->
<div class="data-management" style="margin-top: 30px;">
    <h3>üìä Data Management</h3>
    
    <!-- CSV Upload Instructions -->
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(102,126,234,0.2);">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <span style="font-size: 2em;">üìÅ</span>
            <strong style="font-size: 1.2rem; font-weight: 600;">CSV Upload Guide</strong>
        </div>
        <p style="margin: 8px 0; font-size: 0.95em; line-height: 1.6; opacity: 0.95;">
            Upload a CSV file with columns: <code style="background: rgba(255,255,255,0.25); padding: 3px 8px; border-radius: 4px; font-size: 0.9em;">product_name</code>, 
            <code style="background: rgba(255,255,255,0.25); padding: 3px 8px; border-radius: 4px; font-size: 0.9em;">quantity_sold</code>, 
            <code style="background: rgba(255,255,255,0.25); padding: 3px 8px; border-radius: 4px; font-size: 0.9em;">sale_price</code>, 
            <code style="background: rgba(255,255,255,0.25); padding: 3px 8px; border-radius: 4px; font-size: 0.9em;">sale_date</code>
        </p>
        <p style="margin: 8px 0 0; font-size: 0.88em; opacity: 0.9;">
            üí° Optional: <code style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 3px;">category</code>, 
            <code style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 3px;">unit_cost</code>, 
            <code style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 3px;">stock_after_sale</code>
        </p>
    </div>
    
    <div class="data-controls">
        <div class="control-group">
            <h4>Import Data</h4>
            <input type="file" id="csv-import" accept=".csv" style="margin-bottom: 10px;" />
            <button class="btn btn-primary" id="upload-csv-btn">üì§ Upload CSV File</button>
            <div id="import-status" style="margin-top: 10px;"></div>
        </div>
        
        <div class="control-group">
            <h4>Export Data</h4>
            <button class="btn btn-secondary" id="download-all-data-btn">Download All Data (CSV)</button>
        </div>

        <div class="control-group">
            <h4>Previous Imports</h4>
            <div id="imports-list" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px;">
                <p style="color: #999;">Loading imports...</p>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="card" style="padding:16px;">
    <h3>üì¶ Products</h3>
    <p style="color:#6b7280;">View products and inventory levels. Product management requires admin or manager privileges.</p>
</div>
{% endif %}

<!-- Product Management Modal -->
<div id="product-modal" class="modal">
    <div class="modal-content" style="max-width: 520px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-bottom: none; padding: 28px 32px;">
            <h3 id="product-modal-title" style="color: white; font-size: 1.4rem; font-weight: 600; margin: 0;">Add Product</h3>
            <span class="modal-close" onclick="closeProductModal()" style="color: white; opacity: 0.9; font-size: 28px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer; transition: all 0.2s;">&times;</span>
        </div>
        <form id="product-modal-form" style="padding: 32px;">
            <input type="hidden" id="modal-product-id" />
            <div class="form-group" style="margin-bottom: 24px;">
                <label for="modal-product-name" style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #2d3748; font-size: 14px; margin-bottom: 8px;">
                    <span style="font-size: 18px;">üì¶</span> Product Name *
                </label>
                <input type="text" id="modal-product-name" required style="width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; transition: all 0.2s;" />
            </div>
            <div class="form-group" style="margin-bottom: 24px;">
                <label for="modal-product-category" style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #2d3748; font-size: 14px; margin-bottom: 8px;">
                    <span style="font-size: 18px;">üè∑Ô∏è</span> Category
                </label>
                <input type="text" id="modal-product-category" style="width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; transition: all 0.2s;" />
            </div>
            <div class="form-group" style="margin-bottom: 24px;">
                <label for="modal-product-cost" style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #2d3748; font-size: 14px; margin-bottom: 8px;">
                    <span style="font-size: 18px;">üí∞</span> Unit Cost (‚Ç±)
                </label>
                <input type="number" id="modal-product-cost" step="0.01" min="0" style="width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; transition: all 0.2s;" />
            </div>
            <div class="form-group" id="modal-stock-group" style="margin-bottom: 28px;">
                <label for="modal-product-stock" style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #2d3748; font-size: 14px; margin-bottom: 8px;">
                    <span style="font-size: 18px;">üìä</span> Initial Stock
                </label>
                <input type="number" id="modal-product-stock" value="0" min="0" style="width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; transition: all 0.2s;" />
            </div>
            <div class="modal-footer" style="display: flex; gap: 12px; padding-top: 8px;">
                <button type="button" class="btn btn-secondary" onclick="closeProductModal()" style="flex: 1; padding: 14px; border-radius: 10px; font-size: 15px; font-weight: 600; background: #f7fafc; color: #4a5568; border: 2px solid #e2e8f0; cursor: pointer; transition: all 0.2s;">Cancel</button>
                <button type="submit" class="btn btn-primary" id="product-modal-submit" style="flex: 2; padding: 14px; border-radius: 10px; font-size: 15px; font-weight: 600; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">Save Product</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="modal">
    <div class="modal-content modal-small" style="max-width: 460px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-bottom: none; padding: 28px 32px;">
            <h3 style="color: white; font-size: 1.3rem; font-weight: 600; margin: 0; display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 24px;">‚ö†Ô∏è</span> Confirm Deletion
            </h3>
            <span class="modal-close" onclick="closeDeleteModal()" style="color: white; opacity: 0.9; font-size: 28px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer; transition: all 0.2s;">&times;</span>
        </div>
        <div class="modal-body" style="padding: 32px;">
            <p id="delete-modal-message" style="font-size: 15px; color: #2d3748; margin-bottom: 16px; line-height: 1.6;"></p>
            <p id="delete-modal-warning" style="color: #ef4444; font-size: 14px; margin-top: 16px; padding: 12px; background: #fef2f2; border-left: 4px solid #ef4444; border-radius: 6px;"></p>
        </div>
        <div class="modal-footer" style="display: flex; gap: 12px; padding: 0 32px 32px;">
            <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()" style="flex: 1; padding: 14px; border-radius: 10px; font-size: 15px; font-weight: 600; background: #f7fafc; color: #4a5568; border: 2px solid #e2e8f0; cursor: pointer; transition: all 0.2s;">Cancel</button>
            <button type="button" id="confirm-delete-btn" class="btn btn-danger" style="flex: 1; padding: 14px; border-radius: 10px; font-size: 15px; font-weight: 600; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);">Delete Product</button>
        </div>
    </div>
</div>

<!-- Inventory Update Modal -->
<div id="inventory-modal" class="modal">
    <div class="modal-content modal-small" style="max-width: 520px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-bottom: none; padding: 28px 32px;">
            <h3 style="color: white; font-size: 1.3rem; font-weight: 600; margin: 0; display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 24px;">üì¶</span> Update Inventory
            </h3>
            <span class="modal-close" onclick="closeInventoryModal()" style="color: white; opacity: 0.9; font-size: 28px; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer; transition: all 0.2s;">&times;</span>
        </div>
        <form id="inventory-modal-form" style="padding: 32px;">
            <input type="hidden" id="inventory-product-id" />
            <div class="form-group" style="margin-bottom: 20px; padding: 16px; background: #f0fdf4; border-radius: 10px; border-left: 4px solid #10b981;">
                <label style="font-size: 13px; color: #065f46; font-weight: 600; margin-bottom: 4px; display: block;">Product</label>
                <strong id="inventory-product-name" style="font-size: 16px; color: #047857;"></strong>
            </div>
            <div class="form-group" style="margin-bottom: 24px; padding: 16px; background: #eff6ff; border-radius: 10px; border-left: 4px solid #3b82f6;">
                <label style="font-size: 13px; color: #1e40af; font-weight: 600; margin-bottom: 4px; display: block;">Current Stock</label>
                <strong id="inventory-current-stock" style="font-size: 20px; color: #2563eb;"></strong>
            </div>
            <div class="form-group" style="margin-bottom: 24px;">
                <label for="inventory-operation" style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #2d3748; font-size: 14px; margin-bottom: 8px;">
                    <span style="font-size: 18px;">üîÑ</span> Operation
                </label>
                <select id="inventory-operation" required style="width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; transition: all 0.2s; background: white; cursor: pointer;">
                    <option value="add">‚ûï Add Stock</option>
                    <option value="remove">‚ûñ Remove Stock</option>
                </select>
            </div>
            <div class="form-group" style="margin-bottom: 24px;">
                <label for="inventory-quantity" style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #2d3748; font-size: 14px; margin-bottom: 8px;">
                    <span style="font-size: 18px;">üî¢</span> Quantity *
                </label>
                <input type="number" id="inventory-quantity" min="1" required style="width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; transition: all 0.2s;" />
            </div>
            <div class="form-group" style="margin-bottom: 28px;">
                <label for="inventory-reason" style="display: flex; align-items: center; gap: 8px; font-weight: 600; color: #2d3748; font-size: 14px; margin-bottom: 8px;">
                    <span style="font-size: 18px;">üìù</span> Reason (optional)
                </label>
                <input type="text" id="inventory-reason" placeholder="e.g., Received shipment, Damaged goods..." style="width: 100%; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; transition: all 0.2s;" />
            </div>
            <div class="modal-footer" style="display: flex; gap: 12px; padding-top: 8px;">
                <button type="button" class="btn btn-secondary" onclick="closeInventoryModal()" style="flex: 1; padding: 14px; border-radius: 10px; font-size: 15px; font-weight: 600; background: #f7fafc; color: #4a5568; border: 2px solid #e2e8f0; cursor: pointer; transition: all 0.2s;">Cancel</button>
                <button type="submit" class="btn btn-primary" style="flex: 2; padding: 14px; border-radius: 10px; font-size: 15px; font-weight: 600; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">Update Inventory</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='app.js') }}"></script>
<script>
    // Initialize products page
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Products page loaded');
        
        // Load products list
        if (typeof loadProductsList === 'function') {
            loadProductsList();
        }
        
        // Load import history
        if (typeof loadImportHistory === 'function') {
            loadImportHistory();
        }
        
        // Set up search functionality
        const searchInput = document.getElementById('product-search');
        if (searchInput) {
            searchInput.addEventListener('input', function(e) {
                if (typeof filterProducts === 'function') {
                    filterProducts(e.target.value);
                }
            });
        }
        
        // CSV upload button handler
        const uploadBtn = document.getElementById('upload-csv-btn');
        if (uploadBtn) {
            uploadBtn.addEventListener('click', function() {
                if (typeof handleCSVUpload === 'function') {
                    handleCSVUpload();
                }
            });
        }
        
        // Download all data button handler
        const downloadBtn = document.getElementById('download-all-data-btn');
        if (downloadBtn) {
            downloadBtn.addEventListener('click', function() {
                if (typeof downloadAllData === 'function') {
                    downloadAllData();
                }
            });
        }
    });
</script>
{% endblock %}
